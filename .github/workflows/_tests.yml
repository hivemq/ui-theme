on:
  workflow_call:

jobs:
  build:
    name: 👷 Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: ./.github/actions/setup

      - run: pnpm build

  visual_tests:
    name: 🎨 Visual Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: ./.github/actions/setup
        with:
          run_install: true

      - name: 🧪 start server and run tests
        run: |
          pnpm dev &
          sleep 30

          echo "Server started"
          sleep 1

          echo "Install Chromium Browser"
          pnpx playwright@1.42.1 install chromium

          echo "Oli told me sleep 😴"
          sleep 1

          echo "Run tests"
          pnpm test:ci

      - name: ⬆️ Upload Difference Images
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: visual-test-screenshots
          path: ./testing/artifacts/image_diffs
          if-no-files-found: ignore
          retention-days: 2
